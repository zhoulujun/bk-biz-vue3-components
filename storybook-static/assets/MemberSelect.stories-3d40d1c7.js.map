{"version":3,"file":"MemberSelect.stories-3d40d1c7.js","sources":["../../src/components/member-selector/index.tsx"],"sourcesContent":["import { Message, TagInput } from 'bkui-vue';\nimport './index.scss';\nimport { computed, defineComponent, PropType, ref, shallowRef, VNode } from 'vue';\n\nexport default defineComponent({\n  name: 'MemberSelector',\n  props: {\n    optionLimit: {\n      type: Number,\n      default: 15,\n    },\n    size: {\n      type: String as PropType<'mini' | 'small' | 'large'>,\n      default: null,\n    },\n    allowCreate: {\n      type: Boolean,\n      default: true,\n    },\n    maxData: {\n      type: Number,\n      default: -1,\n    },\n    cacheTimeout: {\n      type: Number,\n      default: 1000 * 60 * 60 * 24,\n    },\n    contentWidth: {\n      type: Number,\n      default: 200,\n    },\n    contentMaxHeight: {\n      type: Number,\n      default: 300,\n    },\n    placeholder: {\n      type: String,\n      default: '请输入用户名',\n    },\n    trigger: {\n      type: String as PropType<'focus' | 'search'>,\n      default: 'search',\n    },\n    value: {\n      type: String,\n      default: 'english_name',\n    },\n    label: {\n      type: String,\n      default: 'chinese_name',\n    },\n    useGroup: Boolean,\n    cacheable: Boolean,\n    extraGroup: {\n      type: Array,\n      default: (): any[] => [],\n    },\n    modelValue: {\n      type: Array as PropType<string[]> || String,\n      default: '',\n    },\n    avatars: {\n      type: Function,\n      default: (node: any) => node.src,\n    },\n    api: {\n      type: String || Function,\n      default: '',\n    },\n    tpl: {\n      type: Function as PropType<(node: any, h: Function, ctx: VNode) => VNode>,\n    },\n    tagTpl: {\n      type: Function as PropType<(node: any, highlightKeyword: Function, h: Function, ctx: VNode) => VNode>,\n    },\n  },\n  emits: ['update:modelValue', 'change'],\n  setup(props, { emit }) {\n    const content = ref<string[] | string>(props.modelValue);\n    const memberList = shallowRef<any[]>([]);\n    const loading = ref(true);\n    const mData = computed(() => {\n      if (props.useGroup) {\n        return props.extraGroup.concat([\n          {\n            english_name: '成员',\n            chinese_name: '成员',\n            children: memberList.value,\n          },\n        ]);\n      }\n      return memberList.value;\n    });\n\n    function handleSelectChange(data: string[]) {\n      emit('change', data);\n      emit('update:modelValue', data);\n    }\n\n    function requestMemberData() {\n      loading.value = true;\n\n      if (localStorage.getItem('member')) {\n        const cache = JSON.parse(localStorage.getItem('member'));\n        const { timestamp } = cache;\n        if (new Date().valueOf() - timestamp > props.cacheTimeout) {\n          loading.value = false;\n          memberList.value = cache.data;\n          return true;\n        }\n      }\n      // const callback = `jsonp_init_bk_member${Math.ceil(Math.random() * 1000)}`;\n      const callback = `jsonp_init_bk_member`;\n      const script = document.createElement('script');\n      let api = typeof props.api === 'function' ? props.api() : props.api;\n      if (api.includes('?')) {\n        script.src = `${api}&callback=${callback}`;\n      } else {\n        script.src = `${api}?callback=${callback}`;\n      }\n      document.body.appendChild(script);\n      // @ts-ignore\n      window[callback] = (res: any) => {\n        if (res.result) {\n          loading.value = false;\n          memberList.value = res.data;\n        } else {\n          Message({ theme: 'error', message: res.message });\n        }\n        if (props.cacheable) {\n          const cache = {\n            timestamp: new Date().valueOf(),\n            data: res.data,\n          };\n          localStorage.setItem('member', JSON.stringify(cache));\n        }\n        document.body.removeChild(script);\n      };\n    }\n\n    requestMemberData();\n    return {\n      content,\n      memberList,\n      loading,\n      handleSelectChange,\n      mData,\n    };\n  },\n  render() {\n    const memberTpl = (\n      node: { recipients: any; english_name: string; chinese_name: string; [props: string]: any },\n      highlightKeyword: any,\n    ) => (\n      <div class=\"flex-row align-items-center p-min\">\n        <img\n          class=\"avatar-box overflow-hidden mr-min\"\n          src={this.avatars(node)}\n          alt={'人员头像'}/>\n        <div\n          class=\"text flex-1 text-ov\"\n          v-html={`${highlightKeyword(node[this.value])} (${node[this.label]})`}></div>\n      </div>\n    );\n    const tagTpl = (node: any) => (\n      <div class=\"tag\">\n        <span class=\"text\"><label\n          style=\"text-decoration: underline;\">{node[this.value]}</label> ({node[this.label]})</span>\n      </div>\n    );\n    return (\n      <TagInput\n        v-model={this.content}\n        placeholder={this.placeholder}\n        saveKey={this.value}\n        searchKey={this.value}\n        trigger={this.trigger}\n        maxData={this.maxData}\n        hasDeleteIcon={true}\n        allowCreate={this.allowCreate}\n        disabled={this.loading}\n        tpl={this.tpl || memberTpl}\n        tagTpl={this.tagTpl || tagTpl}\n        maxResult={this.optionLimit}\n        contentWidth={this.contentWidth}\n        contentMaxHeight={this.contentMaxHeight}\n        list={this.mData}\n        useGroup={this.useGroup}\n        allowAutoMatch={true}\n        class={'full-width'}\n        onChange={this.handleSelectChange}\n      />\n    );\n  },\n});\n"],"names":["defineComponent","name","props","optionLimit","type","Number","default","size","String","allowCreate","Boolean","maxData","cacheTimeout","contentWidth","contentMaxHeight","placeholder","trigger","value","label","useGroup","cacheable","extraGroup","Array","modelValue","avatars","Function","node","src","api","tpl","tagTpl","emits","setup","emit","content","ref","memberList","shallowRef","loading","mData","computed","concat","english_name","chinese_name","children","handleSelectChange","data","requestMemberData","localStorage","getItem","cache","JSON","parse","timestamp","Date","valueOf","callback","script","document","createElement","includes","body","appendChild","window","res","result","Message","theme","message","setItem","stringify","removeChild","render","memberTpl","highlightKeyword","_createVNode","_createTextVNode","TagInput","$event"],"mappings":"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"}